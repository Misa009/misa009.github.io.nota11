<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Notas</title>
  <style>
    :root{
      --bg0:#000;
      --bg1:#050507;
      --glass: rgba(28,28,30,.72);
      --glass-2: rgba(44,44,46,.78);
      --glass-3: rgba(58,58,60,.88);
      --line: rgba(255,255,255,.08);
      --text:#fff;
      --muted:#a1a1a6;
      --muted-2:#8e8e93;
      --accent:#ffd60a;
      --danger:#ff453a;
      --blue:#0a84ff;
      --font:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      --shadow: 0 18px 50px rgba(0,0,0,.65);
      --glow: inset 0 1px 0 rgba(255,255,255,.06), inset 0 -1px 0 rgba(0,0,0,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1a1a1c 0%, transparent 55%),
        radial-gradient(900px 700px at 110% 10%, #141416 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color:var(--text);
      font-family:var(--font);
      -webkit-font-smoothing:antialiased;
      overflow:hidden;
      touch-action: manipulation;
    }
    .glass{
      background:var(--glass);
      backdrop-filter:saturate(180%) blur(22px);
      -webkit-backdrop-filter:saturate(180%) blur(22px);
      border:1px solid var(--line);
      box-shadow:var(--shadow), var(--glow);
    }
    .glass-2{ background:var(--glass-2); }
    .glass-3{ background:var(--glass-3); }

    .app{position:fixed;inset:0;display:flex;flex-direction:column;}

    .nav{
      height:48px;flex:0 0 auto;
      display:flex;align-items:center;gap:6px;
      padding:0 10px;
      position:relative;z-index:30;
    }
    .nav .title{
      font-weight:700;font-size:17px;letter-spacing:.2px;
      color:var(--text);margin:0 auto;pointer-events:none;
      max-width:60%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .nav .left,.nav .right{display:flex;align-items:center;gap:2px;min-width:72px;}
    .nav .right{justify-content:flex-end}
    .nav-btn{
      background:transparent;border:0;color:var(--accent);
      font-size:16px;font-weight:600;padding:6px 8px;border-radius:8px;cursor:pointer;
    }
    .nav-btn.blue{ color:var(--blue); }

    .icon-btn{
      width:34px;height:34px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);font-size:15px;cursor:pointer;
      display:grid;place-items:center;
      backdrop-filter:saturate(180%) blur(18px);
    }

    .main{position:relative;flex:1;min-height:0;overflow:hidden;}

    .screen{
      position:absolute;inset:0;display:flex;flex-direction:column;min-height:0;
      transition:transform .28s cubic-bezier(.2,.8,.2,1);
    }
    #foldersScreen{
      transform:translateX(0);z-index:5;
      background:
        radial-gradient(1000px 700px at 0% -20%, #151518 0%, transparent 60%),
        linear-gradient(180deg, #07070a, #000);
      isolation:isolate;
    }
    #notesScreen{transform:translateX(100%);z-index:1;}
    .show-notes #foldersScreen{transform:translateX(-100%);}
    .show-notes #notesScreen{transform:translateX(0);}

    .folders-wrap{flex:1;min-height:0;overflow:auto;padding:10px 10px 90px;}
    .section-title{
      color:var(--muted);font-weight:800;font-size:12px;letter-spacing:.5px;text-transform:uppercase;
      padding:12px 6px 6px;
    }
    .folder-cell{
      display:flex;align-items:center;gap:10px;
      padding:12px 14px;margin-bottom:8px;border-radius:14px;cursor:pointer;
      position:relative;
    }
    .folder-icon{
      width:24px;height:18px;border-radius:5px;background:var(--accent);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.35);
      flex:0 0 auto;
    }
    .folder-name{font-size:16px;font-weight:700;}
    .folder-count{margin-left:auto;color:var(--muted-2);font-weight:800;font-size:13px;}

    .minus{
      display:none; width:22px;height:22px;border-radius:999px;background:var(--danger);
      color:#fff;font-weight:900;font-size:16px;align-items:center;justify-content:center;
      box-shadow:0 6px 14px rgba(0,0,0,.6);
      flex:0 0 auto;
    }
    .handle{
      display:none; color:var(--muted-2); font-weight:900; letter-spacing:2px;
      margin-left:8px; font-size:14px; opacity:.9;
    }
    .edit-mode .minus, .edit-mode .handle{display:flex;}

    .sidebar{
      position:absolute;top:0;bottom:0;left:0;width:min(86vw,340px);
      display:flex;flex-direction:column;min-height:0;transform:translateX(-100%);
      transition:transform .28s cubic-bezier(.2,.8,.2,1);z-index:6;
    }
    .sidebar.open{transform:translateX(0);}
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:5;}
    .overlay.show{opacity:1;pointer-events:auto;}

    .search-row{padding:8px 10px;display:flex;flex-direction:column;gap:8px;}
    .search{
      width:100%;border:1px solid transparent;color:var(--text);
      padding:9px 10px;font-size:15px;border-radius:10px;outline:none;
      background:rgba(255,255,255,.06);
    }
    .count{font-size:12px;color:var(--muted-2);font-weight:800;padding:0 2px;}

    .list{flex:1;min-height:0;overflow:auto;padding:8px 8px 90px;}
    .note-cell{
      padding:10px 12px;margin-bottom:6px;border-radius:12px;cursor:pointer;
      transition:background .12s ease,transform .02s ease;border:1px solid transparent;
    }
    .note-cell:hover{background:rgba(255,255,255,.04);}
    .note-title{
      font-size:16px;font-weight:700;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;
    }
    .note-meta{font-size:12px;color:var(--muted-2);font-weight:700;display:flex;gap:6px;align-items:center;}
    .note-preview{font-size:14px;color:#d1d1d6;margin-top:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .editor{position:absolute;inset:0;display:flex;flex-direction:column;min-height:0;z-index:1;}
    .editor-top{
      padding:6px 8px;display:flex;align-items:center;gap:8px;
      border-bottom:1px solid var(--line);
    }
    .editor-top .date{
      font-size:12px;color:var(--muted);font-weight:900;
      padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.06);
    }
    .editor-top .actions{margin-left:auto;display:flex;gap:6px;}
    textarea{
      flex:1;min-height:0;width:100%;background:transparent;color:var(--text);
      border:0;outline:none;resize:none;font-family:var(--font);
      font-size:18px;line-height:1.55;padding:16px 14px 120px;caret-color:var(--accent);
    }
    .empty{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;color:var(--muted);text-align:center;padding:30px;}

    /* FABs */
    .fab{
      position:absolute;right:18px;bottom:18px;width:56px;height:56px;border-radius:16px;
      background:var(--accent);color:#000;font-size:26px;font-weight:900;display:grid;place-items:center;border:0;cursor:pointer;
      box-shadow:0 14px 38px rgba(0,0,0,.6);z-index:40;
    }
    /* liquid-glass folder FAB */
    .fab-glass{
      background:rgba(255,255,255,.10);
      border:1px solid var(--line);
      color:var(--blue);
      font-size:22px;
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
    }

    /* Action sheet */
    .sheet-wrap{
      position:absolute; inset:0; display:none; place-items:end center; z-index:60;
      background:rgba(0,0,0,.35);
    }
    .sheet-wrap.show{ display:grid; }
    .sheet{
      width:min(96vw, 420px); padding:10px; margin:0 0 12px;
      border-radius:16px;
    }
    .sheet .group{ border-radius:14px; overflow:hidden; }
    .sheet .row{
      padding:14px 14px; font-size:17px; font-weight:600; color:var(--text);
      display:flex; align-items:center; justify-content:center; gap:8px;
      border-bottom:1px solid var(--line); cursor:pointer;
      background:rgba(255,255,255,.04);
    }
    .sheet .row:last-child{ border-bottom:0; }
    .sheet .row.danger{ color:var(--danger); }
    .sheet .row.muted{ color:var(--muted); font-weight:700; font-size:14px; cursor:default; }
    .sheet .cancel{ margin-top:8px; border-radius:14px; }

    @media (min-width:980px){
      body{overflow:auto;}
      .app{position:relative;height:100vh;}
      #foldersScreen{display:none;}
      #notesScreen{transform:none;position:relative;inset:auto;}
      .main{display:grid;grid-template-columns:360px 1fr;}
      .sidebar{position:relative;transform:none !important;width:auto;z-index:1;}
      .overlay{display:none;}
      .editor{position:relative;}
    }
  </style>
</head>
<body>
<div class="app glass" id="appRoot">
  <div class="nav glass">
    <div class="left">
      <button class="nav-btn" id="leftBtn">Carpetas</button>
    </div>
    <div class="title" id="navTitle">Carpetas</div>
    <div class="right">
      <button class="nav-btn blue" id="editBtn">Editar</button>
    </div>
  </div>

  <div class="main">
    <section class="screen" id="foldersScreen">
      <div class="folders-wrap" id="foldersList"></div>
      <button class="fab fab-glass" id="newFolderFab" title="Nueva carpeta" aria-label="Nueva carpeta">
        <!-- folder+ icon -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3.5 7.5h6l2 2h9c.6 0 1 .4 1 1v7.5c0 .6-.4 1-1 1h-17c-.6 0-1-.4-1-1V8.5c0-.6.4-1 1-1Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M12 12v6M9 15h6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </button>
    </section>

    <section class="screen" id="notesScreen">
      <aside class="sidebar glass" id="sidebar">
        <div class="search-row">
          <input class="search" id="searchInput" placeholder="Buscar" />
          <div class="count" id="countLabel">0 notas</div>
        </div>
        <div class="list" id="list"></div>
      </aside>

      <div class="overlay" id="overlay"></div>

      <section class="editor" id="editor">
        <div class="editor-top glass" id="editorTop" style="display:none;">
          <div class="date" id="dateLabel"></div>
          <div class="actions">
            <button class="icon-btn" id="trashBtn" title="Eliminar nota" aria-label="Eliminar nota">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 7h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M7 7l1 12a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1l1-12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </button>
            <button class="icon-btn" id="noteMoreBtn" title="Más opciones" aria-label="Más opciones">•••</button>
          </div>
        </div>

        <div class="empty" id="emptyState">
          <div class="big" style="font-size:20px;font-weight:800;color:#fff;opacity:.9;">Sin nota seleccionada</div>
          <div>Abre el panel lateral para elegir una nota.</div>
        </div>

        <button class="fab" id="newNoteFab" title="Nueva nota">✎</button>
      </section>
    </section>
  </div>

  <div class="sheet-wrap" id="sheetWrap">
    <div class="sheet">
      <div class="group glass-2 glass" id="sheetGroup"></div>
      <div class="group glass-2 glass cancel">
        <div class="row" id="sheetCancel">Cancelar</div>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "notas_ios_glass_v8";

  function makeList(title, arr){
    return title + "\\n" + arr.map((x,i)=>`${i+1} ${x}`).join("\\n");
  }

  const cities = ["París","Madrid","Roma","Londres","Lisboa","Estambul","Marrakech","Tokio","Nueva York","Berlín","Viena","Praga","Ámsterdam",
    "Barcelona","Sevilla","Granada","Málaga","Córdoba","Valencia","Zaragoza","Bilbao","San Sebastián","Alicante","Murcia","Palma","Tenerife",
    "Oporto","Bruselas","Ginebra","Zúrich","Múnich","Hamburgo","Colonia","Frankfurt","Milán","Florencia","Venecia","Nápoles","Turín","Bolonia",
    "Atenas","Salónica","Dublín","Edimburgo","Glasgow","Copenhague","Estocolmo","Oslo","Helsinki","Reikiavik","Varsovia","Cracovia","Budapest",
    "Bucarest","Sofía","Belgrado","Zagreb","Liubliana","Sarajevo","Skopie","Tirana","Kiev","San Petersburgo","Moscú","Doha","Dubái","Abu Dabi",
    "Riad","El Cairo","Casablanca","Túnez","Argel","Dakar","Nairobi","Ciudad del Cabo","Johannesburgo","Lagos","Accra","Addis Abeba","Bangkok",
    "Singapur","Kuala Lumpur","Hanoi","Ho Chi Minh","Manila","Seúl","Busan","Pekín","Shanghái","Hong Kong","Taipéi","Sydney","Melbourne","Perth",
    "Auckland"];
  const countries = ["España","Francia","Italia","Alemania","Portugal","Reino Unido","Irlanda","Bélgica","Países Bajos","Luxemburgo","Suiza","Austria","Suecia",
    "Noruega","Finlandia","Dinamarca","Islandia","Polonia","Chequia","Eslovaquia","Hungría","Rumanía","Bulgaria","Grecia","Turquía","Croacia","Serbia",
    "Eslovenia","Bosnia y Herzegovina","Albania","Macedonia del Norte","Ucrania","Rusia","Marruecos","Argelia","Túnez","Egipto","Senegal","Nigeria",
    "Ghana","Kenia","Etiopía","Sudáfrica","Estados Unidos","Canadá","México","Guatemala","Cuba","República Dominicana","Colombia","Venezuela","Ecuador",
    "Perú","Bolivia","Chile","Argentina","Uruguay","Brasil","Paraguay","Australia","Nueva Zelanda","Japón","China","Corea del Sur","Corea del Norte",
    "India","Pakistán","Bangladés","Sri Lanka","Nepal","Tailandia","Vietnam","Camboya","Laos","Malasia","Singapur","Indonesia","Filipinas","Arabia Saudí",
    "Emiratos Árabes Unidos","Qatar","Israel","Jordania","Líbano","Irán","Iraq","Sudán","Uganda","Tanzania","Angola","Mozambique","Madagascar","Chile (repetido?)"];
  // ensure about 100 unique-ish
  const countries100 = [...new Set(countries)].slice(0,100);

  const songs = [
    "Billie Jean — Michael Jackson","Bohemian Rhapsody — Queen","Blinding Lights — The Weeknd","Viva la Vida — Coldplay","Shape of You — Ed Sheeran",
    "Hysteria — Muse","Lose Yourself — Eminem","Titanium — David Guetta ft. Sia","La Flaca — Jarabe de Palo","Mi Gran Noche — Raphael",
    "Smooth Criminal — Michael Jackson","Numb — Linkin Park","In the End — Linkin Park","Believer — Imagine Dragons","Radioactive — Imagine Dragons",
    "Someone Like You — Adele","Rolling in the Deep — Adele","Hello — Adele","Fix You — Coldplay","Yellow — Coldplay",
    "Clocks — Coldplay","The Scientist — Coldplay","Adventure of a Lifetime — Coldplay","Bad Guy — Billie Eilish","Therefore I Am — Billie Eilish",
    "Levitating — Dua Lipa","Don’t Start Now — Dua Lipa","Dance Monkey — Tones and I","Stay — The Kid LAROI & Justin Bieber","Sorry — Justin Bieber",
    "Love Yourself — Justin Bieber","Uptown Funk — Mark Ronson ft. Bruno Mars","Locked Out of Heaven — Bruno Mars","Just the Way You Are — Bruno Mars",
    "Thriller — Michael Jackson","Beat It — Michael Jackson","Smells Like Teen Spirit — Nirvana","Wonderwall — Oasis","Highway to Hell — AC/DC",
    "Back in Black — AC/DC","Sweet Child O’ Mine — Guns N’ Roses","Enter Sandman — Metallica","Nothing Else Matters — Metallica",
    "Seven Nation Army — The White Stripes","Mr. Brightside — The Killers","Somebody Told Me — The Killers","Take On Me — a‑ha",
    "Livin’ on a Prayer — Bon Jovi","It’s My Life — Bon Jovi","Imagine — John Lennon","Hey Jude — The Beatles","Let It Be — The Beatles",
    "Here Comes the Sun — The Beatles","Africa — Toto","Hotel California — Eagles","Stairway to Heaven — Led Zeppelin","Kashmir — Led Zeppelin",
    "Sultans of Swing — Dire Straits","Money for Nothing — Dire Straits","I Gotta Feeling — Black Eyed Peas","Where Is the Love — Black Eyed Peas",
    "Crazy — Gnarls Barkley","Get Lucky — Daft Punk","One More Time — Daft Punk","Harder Better Faster Stronger — Daft Punk",
    "Around the World — Daft Punk","Toxic — Britney Spears","…Baby One More Time — Britney Spears","Poker Face — Lady Gaga",
    "Bad Romance — Lady Gaga","Shallow — Lady Gaga & Bradley Cooper","Rolling Stone — The Weeknd","Starboy — The Weeknd","Save Your Tears — The Weeknd",
    "Can’t Feel My Face — The Weeknd","Viva el Amor — Camela","Corazón Partío — Alejandro Sanz","Amiga mía — Alejandro Sanz",
    "Princesas — Pereza","Lady Madrid — Pereza","La camisa negra — Juanes","A Dios le pido — Juanes","Color Esperanza — Diego Torres",
    "La Bicicleta — Shakira & Carlos Vives","Waka Waka — Shakira","Hips Don’t Lie — Shakira","Despacito — Luis Fonsi","Bailando — Enrique Iglesias",
    "Dákiti — Bad Bunny","Tití me preguntó — Bad Bunny","Me porto bonito — Bad Bunny","Callaita — Bad Bunny","Pepas — Farruko",
    "Aserejé — Las Ketchup","Alaska — Aitana","Mon Amour — Zzoilo & Aitana","La Bachata — Manuel Turizo",
    "Un beso y una flor — Nino Bravo","Libre — Nino Bravo","Mediterráneo — Joan Manuel Serrat","Cantares — Serrat"
  ];
  const songs100 = songs.slice(0,100);

  const seed = {
    folders: [
      { id:"f-icloud-notas", name:"Notas", location:"icloud", ts: Date.now()-2*86400000 },
      { id:"f-icloud-musica", name:"Música", location:"icloud", ts: Date.now()-6*86400000 },
      { id:"f-icloud-viajes", name:"Viajes", location:"icloud", ts: Date.now()-18*86400000 },
      { id:"f-iphone-personal", name:"Personal", location:"onmyiphone", ts: Date.now()-35*86400000 },
      { id:"f-iphone-coches", name:"Coches", location:"onmyiphone", ts: Date.now()-120*86400000 }
    ],
    notes: [
      { folderId:"f-icloud-notas", body: makeList("Marcas de coches (100)", [
        "Mercedes-Benz","BMW","Audi","Volkswagen","Porsche","Ferrari","Lamborghini","Toyota","Honda","Hyundai","Kia","Renault","Peugeot","SEAT","Tesla",
        "BYD","Volvo","Ford","Chevrolet","Lexus","Nissan","Mazda","Subaru","Mitsubishi","Suzuki","Jaguar","Land Rover","Bentley","Rolls‑Royce","Mini",
        "Opel","Fiat","Alfa Romeo","Maserati","Citroën","DS","Skoda","Cupra","Dacia","Saab","Chrysler","Dodge","Jeep","GMC","Cadillac","Buick",
        "Acura","Infiniti","Genesis","Isuzu","Lancia","Abarth","Smart","Polestar","MG","Geely","Chery","Great Wall","Haval","Baojun","Wuling","FAW",
        "Dongfeng","GAC","NIO","Xpeng","Li Auto","Rivian","Lucid","Koenigsegg","Pagani","Bugatti","McLaren","Aston Martin","Lotus","Morgan","Alpine",
        "Citroën (2)","Tata","Mahindra","Holden","Proton","Perodua","Lada","Zastava","UAZ","Scion","Hummer","Ram","Cupra (2)"
      ].slice(0,100)), ts:Date.now()-1*86400000 },

      { folderId:"f-icloud-musica", body: makeList("Canciones (100)", songs100), ts:Date.now()-2*86400000 },
      { folderId:"f-icloud-viajes", body: makeList("Ciudades (100)", cities.slice(0,100)), ts:Date.now()-3*86400000 },
      { folderId:"f-icloud-viajes", body: makeList("Países (100)", countries100), ts:Date.now()-4*86400000 },

      { folderId:"f-iphone-personal", body:`Checklist de show\n1 Preparar baraja\n2 Cargar NFC\n3 Ensayar rutina\n4 Revisar música\n5 Repasar guion`, ts:Date.now()-5*86400000 },

      { folderId:"f-iphone-coches", body:`Coches que quiero mirar\n1 CLA 45 2013\n2 CLA 250 2013\n3 BMW 420i 2017\n4 C220d 2016\n5 CLS 350d 2016`, ts:Date.now()-30*86400000 }
    ]
  };

  let folders = [];
  let notes = [];
  let activeFolderId = null;
  let activeNoteId = null;
  let editMode = false;

  const appRoot = document.getElementById("appRoot");
  const navTitle = document.getElementById("navTitle");
  const leftBtn = document.getElementById("leftBtn");
  const editBtn = document.getElementById("editBtn");
  const foldersList = document.getElementById("foldersList");
  const newFolderFab = document.getElementById("newFolderFab");

  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const listEl = document.getElementById("list");
  const searchInput = document.getElementById("searchInput");
  const countLabel = document.getElementById("countLabel");

  const editorEl = document.getElementById("editor");
  const editorTopEl = document.getElementById("editorTop");
  const emptyStateEl = document.getElementById("emptyState");
  const dateLabel = document.getElementById("dateLabel");
  const newNoteFab = document.getElementById("newNoteFab");
  const noteMoreBtn = document.getElementById("noteMoreBtn");
  const trashBtn = document.getElementById("trashBtn");

  const sheetWrap = document.getElementById("sheetWrap");
  const sheetGroup = document.getElementById("sheetGroup");
  const sheetCancel = document.getElementById("sheetCancel");

  function isDesktop(){ return window.matchMedia("(min-width: 980px)").matches; }
  function uid(prefix){ return (prefix||"id")+"-"+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function nowTs(){ return Date.now(); }

  function firstLine(text){
    const l=(text||"").split("\n").map(s=>s.trim()).find(Boolean);
    return l || "Sin título";
  }
  function preview(text){
    const lines=(text||"").split("\n").map(s=>s.trim()).filter(Boolean);
    if(lines.length<=1) return (lines[0]||"");
    return lines.slice(1).join(" ").slice(0,90);
  }
  function fmtDate(ts){
    const d=new Date(ts);
    return d.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric"});
  }
  function sortNotes(arr){ return arr.slice().sort((a,b)=>b.updatedAt-a.updatedAt); }
  function groupLabel(ts){
    const diff=nowTs()-ts, seven=7*24*60*60*1000;
    if(diff<=seven) return "ÚLTIMOS 7 DÍAS";
    const d=new Date(ts);
    return d.toLocaleDateString("es-ES",{month:"long",year:"numeric"}).toUpperCase();
  }
  function notesInFolder(fid){ return notes.filter(n=>n.folderId===fid); }

  function load(){
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){
      folders=seed.folders.map(f=>({id:f.id,name:f.name,location:f.location,createdAt:f.ts,updatedAt:f.ts}));
      notes=seed.notes.map(n=>({id:uid("n"),folderId:n.folderId,body:n.body,createdAt:n.ts,updatedAt:n.ts}));
      save(); return;
    }
    try{
      const data=JSON.parse(raw)||{};
      folders=data.folders||[];
      notes=data.notes||[];
    }catch(e){
      folders=[]; notes=[];
    }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({folders,notes})); }

  function showFolders(){
    appRoot.classList.remove("show-notes");
    navTitle.textContent="Carpetas";
    leftBtn.textContent="Carpetas";
    editBtn.style.display="inline-block";
    newFolderFab.style.display="grid";
    newNoteFab.style.display="none";
    closeSidebar();
    activeFolderId=null; activeNoteId=null;
    renderFolders(); renderEditor();
  }

  function showNotes(folderId){
    activeFolderId=folderId;
    appRoot.classList.add("show-notes");
    const f=folders.find(x=>x.id===folderId);
    navTitle.textContent=f?.name||"Notas";
    leftBtn.textContent="Carpetas";
    editBtn.style.display="none";
    newFolderFab.style.display="none";
    newNoteFab.style.display="grid";
    activeNoteId=null;
    renderList(); renderEditor();
    if(!isDesktop()) openSidebar();
  }

  function renderFolders(){
    foldersList.innerHTML="";
    appRoot.classList.toggle("edit-mode", editMode);

    const icloud=folders.filter(f=>f.location==="icloud");
    const iphone=folders.filter(f=>f.location==="onmyiphone");

    function section(title,list){
      const h=document.createElement("div");
      h.className="section-title"; h.textContent=title;
      foldersList.appendChild(h);

      list.forEach(f=>{
        const cell=document.createElement("div");
        cell.className="folder-cell glass glass-2";

        const count=notesInFolder(f.id).length;
        cell.innerHTML=`
          <div class="minus" aria-label="Eliminar carpeta">−</div>
          <div class="folder-icon"></div>
          <div class="folder-name">${f.name}</div>
          <div class="folder-count">${count}</div>
          <div class="handle">≡</div>
        `;

        const minus=cell.querySelector(".minus");
        minus.addEventListener("click",(e)=>{ e.stopPropagation(); deleteFolder(f.id); });

        cell.addEventListener("click",()=>{
          if(editMode) renameFolder(f.id);
          else showNotes(f.id);
        });

        foldersList.appendChild(cell);
      });
    }

    section("iCLOUD", icloud);
    section("EN MI IPHONE", iphone);
  }

  function createFolder(){
    // use sheet instead of prompt for iOS reliability
    showSheet([
      {label:"Nueva carpeta", muted:true},
      {label:"Crear en iCloud", onClick:()=>createFolderAt("icloud")},
      {label:"Crear en mi iPhone", onClick:()=>createFolderAt("onmyiphone")},
    ]);
  }
  function createFolderAt(location){
    const name=prompt("Nombre de la carpeta:");
    if(!name) return;
    const f={id:uid("f"),name:name.trim(),location,createdAt:nowTs(),updatedAt:nowTs()};
    folders.push(f); save(); renderFolders();
  }

  function renameFolder(id){
    const f=folders.find(x=>x.id===id); if(!f) return;
    const name=prompt("Renombrar carpeta:", f.name);
    if(!name) return;
    f.name=name.trim(); f.updatedAt=nowTs();
    save(); renderFolders();
    if(activeFolderId===id) navTitle.textContent=f.name;
  }
  function deleteFolder(id){
    const f=folders.find(x=>x.id===id); if(!f) return;
    const count=notesInFolder(id).length;
    if(!confirm(`¿Eliminar carpeta "${f.name}"?\nSe borrarán ${count} notas.`)) return;
    notes=notes.filter(n=>n.folderId!==id);
    folders=folders.filter(x=>x.id!==id);
    save();
    if(activeFolderId===id) showFolders(); else renderFolders();
  }

  function renderList(){
    const q=searchInput.value.trim().toLowerCase();
    const filtered=sortNotes(notesInFolder(activeFolderId))
      .filter(n=>(n.body||"").toLowerCase().includes(q));

    listEl.innerHTML="";
    let last=null;
    filtered.forEach(n=>{
      const g=groupLabel(n.updatedAt);
      if(g!==last){
        const h=document.createElement("div");
        h.className="section-title"; h.textContent=g;
        listEl.appendChild(h); last=g;
      }
      const cell=document.createElement("div");
      cell.className="note-cell glass glass-2";
      cell.addEventListener("click",()=>openNote(n.id));
      cell.innerHTML=`
        <div class="note-title">${firstLine(n.body)}</div>
        <div class="note-meta">
          <span>${fmtDate(n.updatedAt)}</span><span>•</span>
          <span>${(n.body||"").length} caracteres</span>
        </div>
        <div class="note-preview">${preview(n.body)}</div>
      `;
      listEl.appendChild(cell);
    });
    countLabel.textContent=`${filtered.length} nota${filtered.length!==1?"s":""}`;
  }

  function clearEditor(){
    const old=editorEl.querySelector("textarea");
    if(old) old.remove();
  }
  function renderEditor(){
    clearEditor();
    const note=notes.find(n=>n.id===activeNoteId);
    if(!note){
      editorTopEl.style.display="none";
      emptyStateEl.style.display="flex";
      return;
    }
    emptyStateEl.style.display="none";
    editorTopEl.style.display="flex";
    dateLabel.textContent=fmtDate(note.updatedAt);

    const ta=document.createElement("textarea");
    ta.placeholder="Escribe tu nota…";
    ta.value=note.body||"";
    ta.addEventListener("input",()=>{
      note.body=ta.value;
      note.updatedAt=nowTs();
      save(); renderList();
      dateLabel.textContent=fmtDate(note.updatedAt);
    });
    editorEl.insertBefore(ta,newNoteFab);
    setTimeout(()=>ta.focus(),0);
  }

  function createNote(){
    if(!activeFolderId) return;
    const n={id:uid("n"),folderId:activeFolderId,body:"",createdAt:nowTs(),updatedAt:nowTs()};
    notes.push(n); save();
    activeNoteId=n.id;
    renderList(); renderEditor();
    if(!isDesktop()) closeSidebar();
  }
  function openNote(id){
    activeNoteId=id; renderEditor();
    if(!isDesktop()) closeSidebar();
  }
  function deleteNote(id){
    const n=notes.find(x=>x.id===id); if(!n) return;
    const title=firstLine(n.body||"");
    if(!confirm(`¿Eliminar nota?\n"${title}"`)) return;
    notes=notes.filter(x=>x.id!==id);
    activeNoteId=null;
    save(); renderList(); renderEditor();
  }
  function moveNote(id){
    const n=notes.find(x=>x.id===id); if(!n) return;
    const choices=folders.map(f=>f.name).join("\n");
    const name=prompt("Mover a carpeta (nombre exacto):\n"+choices);
    if(!name) return;
    const target=folders.find(f=>f.name.toLowerCase()===name.toLowerCase());
    if(!target){ alert("No encontrada."); return; }
    n.folderId=target.id; n.updatedAt=nowTs();
    save();
    if(target.id!==activeFolderId){
      activeNoteId=null;
      renderList(); renderEditor();
    }else renderList();
  }

  function openSidebar(){ sidebar.classList.add("open"); overlay.classList.add("show"); }
  function closeSidebar(){ sidebar.classList.remove("open"); overlay.classList.remove("show"); }
  overlay.addEventListener("click",closeSidebar);

  function showSheet(rows){
    sheetGroup.innerHTML="";
    rows.forEach(r=>{
      const row=document.createElement("div");
      row.className="row"+(r.danger?" danger":"")+(r.muted?" muted":"");
      row.textContent=r.label;
      if(!r.muted){
        row.addEventListener("click",()=>{ hideSheet(); r.onClick?.(); });
      }
      sheetGroup.appendChild(row);
    });
    sheetWrap.classList.add("show");
  }
  function hideSheet(){ sheetWrap.classList.remove("show"); }
  sheetCancel.addEventListener("click",hideSheet);
  sheetWrap.addEventListener("click",(e)=>{ if(e.target===sheetWrap) hideSheet(); });

  leftBtn.addEventListener("click",showFolders);
  editBtn.addEventListener("click",()=>{
    editMode=!editMode;
    editBtn.textContent=editMode?"Hecho":"Editar";
    renderFolders();
  });

  trashBtn.addEventListener("click",()=>{ if(activeNoteId) deleteNote(activeNoteId); });

  noteMoreBtn.addEventListener("click",()=>{
    const id=activeNoteId; if(!id) return;
    showSheet([
      {label:firstLine(notes.find(n=>n.id===id)?.body||""), muted:true},
      {label:"Mover a carpeta…", onClick:()=>moveNote(id)},
      {label:"Duplicar nota", onClick:()=>{
        const n=notes.find(x=>x.id===id);
        if(!n) return;
        const copy={...n, id:uid("n"), createdAt:nowTs(), updatedAt:nowTs()};
        notes.push(copy); save(); renderList();
      }},
      {label:"Copiar texto", onClick:()=>{
        const txt=notes.find(x=>x.id===id)?.body||"";
        navigator.clipboard?.writeText(txt);
      }},
      {label:"Eliminar nota", danger:true, onClick:()=>deleteNote(id)},
    ]);
  });

  newFolderFab.addEventListener("click",createFolder);
  newNoteFab.addEventListener("click",createNote);
  searchInput.addEventListener("input",renderList);

  load();
  showFolders();
  renderFolders();
  renderEditor();

  window.addEventListener("resize", ()=>{
    if(isDesktop()){
      if(activeFolderId) appRoot.classList.add("show-notes");
      closeSidebar();
    }
  });
</script>
</body>
</html>
